<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Kanban Mini-Trello</title>
<style>
/* Guía de Estilo: colores y tipografía */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f5f5f5;
}
header {
  text-align: center;
  margin-bottom: 20px;
}
#board {
  display: flex;
  justify-content: space-between;
  gap: 10px;
}
.column {
  background-color: #e0e0e0;
  border-radius: 5px;
  padding: 10px;
  width: 32%;
  min-height: 400px;
  display: flex;
  flex-direction: column;
}
.column h2 {
  text-align: center;
}
.card {
  background-color: #fff;
  border-radius: 3px;
  padding: 8px;
  margin-bottom: 8px;
  cursor: grab;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}
#add-task {
  display: flex;
  gap: 5px;
  margin-top: 10px;
}
#new-task-input {
  flex-grow: 1;
  padding: 5px;
}
button {
  padding: 5px 10px;
}
</style>
</head>
<body>
<header>
  <h1>Kanban Mini-Trello</h1>
</header>
<div id="board">
  <div class="column" data-state="Por Hacer" id="col-por-hacer"></div>
  <div class="column" data-state="En Progreso" id="col-en-progreso"></div>
  <div class="column" data-state="Hecho" id="col-hecho"></div>
</div>
<div id="add-task">
  <input type="text" id="new-task-input" placeholder="Nueva tarea...">
  <button id="btn-add">Añadir</button>
</div>
<script>
const STATE_MAP = {
  'col-por-hacer': 'Por Hacer',
  'col-en-progreso': 'En Progreso',
  'col-hecho': 'Hecho'
};

function crearCard(task) {
  const card = document.createElement('div');
  card.className = 'card';
  card.draggable = true;
  card.dataset.id = task.id;
  card.textContent = task.content;
  // Drag events
  card.addEventListener('dragstart', e => {
    e.dataTransfer.setData('text/plain', task.id);
  });
  // Edit inline on dblclick
  card.addEventListener('dblclick', () => editCard(card, task));
  return card;
}

function renderTasks(tasks) {
  Object.values(STATE_MAP).forEach(state => {
    const col = document.querySelector(`.column[data-state="${state}"]`);
    col.innerHTML = '';
  });
  tasks.forEach(task => {
    const card = crearCard(task);
    const col = document.querySelector(`.column[data-state="${task.state}"]`);
    col.appendChild(card);
  });
}

async function fetchTasks() {
  try {
    const res = await fetch('/api/tasks');
    if (!res.ok) throw new Error('Error al obtener tareas');
    const data = await res.json();
    renderTasks(data.tasks);
  } catch (err) {
    alert(err.message);
  }
}

async function addTask(content) {
  try {
    const res = await fetch('/api/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content, state: 'Por Hacer' })
    });
    if (!res.ok) throw new Error('Error al crear tarea');
    const task = await res.json();
    // Append to column
    const card = crearCard(task);
    document.querySelector('.column[data-state="Por Hacer"]').appendChild(card);
  } catch (err) {
    alert(err.message);
  }
}

async function updateTask(id, payload) {
  try {
    const res = await fetch(`/api/tasks/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error('Error al actualizar tarea');
  } catch (err) {
    alert(err.message);
  }
}

function editCard(card, task) {
  const input = document.createElement('input');
  input.type = 'text';
  input.value = task.content;
  input.style.width = '100%';
  card.replaceWith(input);
  input.focus();
  const finishEdit = async () => {
    const newContent = input.value.trim();
    if (newContent && newContent !== task.content) {
      await updateTask(task.id, { content: newContent });
      task.content = newContent;
    }
    input.replaceWith(card);
  };
  input.addEventListener('blur', finishEdit);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') finishEdit();
  });
}

// Drag and drop for columns
document.querySelectorAll('.column').forEach(col => {
  col.addEventListener('dragover', e => e.preventDefault());
  col.addEventListener('drop', async e => {
    const id = e.dataTransfer.getData('text/plain');
    const newState = STATE_MAP[col.id];
    await updateTask(id, { state: newState });
    // Move card in DOM
    const card = document.querySelector(`.card[data-id="${id}"]`);
    if (card) col.appendChild(card);
  });
});

// Add task button
document.getElementById('btn-add').addEventListener('click', () => {
  const input = document.getElementById('new-task-input');
  const content = input.value.trim();
  if (!content) return;
  addTask(content);
  input.value = '';
});

// Inicializar
fetchTasks();
</script>
</body>
</html>