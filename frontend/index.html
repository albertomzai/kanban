<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kanban Board</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Tablero Kanban</h1>

        <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
            <!-- Columna: Por Hacer -->
            <div class="col card-por-hacer">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-primary text-white">Por Hacer</div>
                    <div class="card-body">

                        <!-- Formulario para añadir tareas -->
                        <form id="nueva-tarea-form" class="mb-3">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" placeholder="Nueva tarea..." required>
                                <button class="btn btn-primary" type="submit">Añadir</button>
                            </div>
                        </form>

                        <!-- Tarjetas -->
                        <div id="tarjetas-por-hacer" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>

            <!-- Columna: En Progreso -->
            <div class="col card-en-progreso">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-info text-white">En Progreso</div>
                    <div class="card-body">

                        <!-- Tarjetas -->
                        <div id="tarjetas-en-progreso" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>

            <!-- Columna: Hecho -->
            <div class="col card-hecha">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-success text-white">Hecho</div>
                    <div class="card-body">

                        <!-- Tarjetas -->
                        <div id="tarjetas-hechas" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de éxito -->
        <div id="mensaje-satisfactorio" class="alert alert-success d-none">Tarea actualizada correctamente.</div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            const tarjetasPorHacer = document.getElementById('tarjetas-por-hacer');
            const tarjetasEnProgreso = document.getElementById('tarjetas-en-progreso');
            const tarjetasHechas = document.getElementById('tarjetas-hechas');

            // Simular carga de tareas (en producción se llamaría a la API)
            const tareasIniciales = [
                { id: '1', contenido: 'Hacer el ejercicio', estado: 'por-hacer' },
                { id: '2', contenido: 'Revisar documentación', estado: 'en-progreso' }
            ];

            function renderizarTarjetas(tareas, columna) {
                const lista = document.getElementById(columna);
                lista.innerHTML = '';

                tareas.forEach(tarea => {
                    const tarjeta = document.createElement('div');
                    tarjeta.className = 'card h-100 shadow-sm draggable';
                    tarjeta.draggable = true;
                    tarjeta.setAttribute('data-id', tarea.id);

                    tarjeta.innerHTML = `
                        <div class="card-header">${tarea.contenido}</div>
                        <div class="card-body d-flex justify-content-between align-items-center bg-light rounded-bottom p-2">
                            <span class="badge bg-success">En progreso</span>
                        </div>
                    `;

                    lista.appendChild(tarjeta);
                });
            }

            // Iniciar con tareas iniciales
            renderizarTarjetas(tareasIniciales, 'tarjetas-por-hacer');

            // Evento de arrastrar y soltar tarjetas
            document.addEventListener('dragstart', function(event) {
                const target = event.target.closest('.draggable');
                if (target && target.draggable) {
                    event.dataTransfer.setData('text/plain', target.getAttribute('data-id'));
                }
            });

            document.addEventListener('dragover', function(event) {
                event.preventDefault();
            });

            document.addEventListener('drop', function(event) {
                event.preventDefault();
                const tareaId = event.dataTransfer.getData('text/plain');
                const tarjeta = document.querySelector(`[data-id='${tareaId}']`);

                if (!tarjeta) return;

                const columnaDestino = event.target.closest('.card');
                const estadoDestino = columnaDestino.classList.contains('card-por-hacer') ? 'por-hacer' :
                                    columnaDestino.classList.contains('card-en-progreso') ? 'en-progreso' : 'hecha';

                // Mostrar tarjeta en la nueva columna
                const listaDestino = document.getElementById(columnaDestino.id.replace('-columna', ''));
                tarjeta.draggable = false;

                fetch(`/api/tasks/${tareaId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: estadoDestino })
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        document.getElementById('mensaje-satisfactorio').classList.remove('d-none');
                        setTimeout(() => {
                            document.getElementById('mensaje-satisfactorio').classList.add('d-none');
                        }, 3000);
                    } else {
                        alert('Error al mover la tarea: ' + data.message);
                    }
                });
            });

            // Manejar click para editar contenido de tarjeta
            document.querySelectorAll('.draggable').forEach(tarjeta => {
                tarjeta.addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.className = 'form-control';
                    input.type = 'text';
                    input.value = tarjeta.querySelector('.card-header').textContent;

                    tarjeta.innerHTML = `
                        <div class="card-header">${tarjeta.querySelector('.card-header').textContent}</div>
                        <div class="card-body d-flex justify-content-between align-items-center bg-light rounded-bottom p-2">
                            <span class="badge bg-success">En progreso</span>
                        </div>
                    `;

                    input.addEventListener('blur', function() {
                        const contenido = this.value.trim();
                        if (contenido) {
                            tarjeta.querySelector('.card-header').textContent = contenido;
                        } else {
                            tarjeta.removeChild(this);
                        }
                    });

                    input.focus();
                });
            });

            // Manejar envío del formulario de nuevas tareas
            document.getElementById('nueva-tarea-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const contenido = this.querySelector('input[type="text"]').value;

                if (!contenido.trim()) return;

                fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contenido, estado: 'por-hacer' })
                }).then(response => response.json()).then(data => {
                    if (data.success) {
                        const tarjeta = document.createElement('div');
                        tarjeta.className = 'card h-100 shadow-sm draggable';
                        tarjeta.draggable = true;
                        tarjeta.setAttribute('data-id', data.id);

                        tarjeta.innerHTML = `
                            <div class="card-header">${contenido}</div>
                            <div class="card-body d-flex justify-content-between align-items-center bg-light rounded-bottom p-2">
                                <span class="badge bg-success">En progreso</span>
                            </div>
                        `;

                        tarjetasPorHacer.appendChild(tarjeta);
                    } else {
                        alert('Error al crear tarea: ' + data.message);
                    }
                });

                this.querySelector('input[type="text"]').value = '';
            });
        </script>
    </div>
</body>
</html>