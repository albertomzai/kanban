<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kanban Mini-Trello</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .board {
            display: flex;
            gap: 1rem;
            min-height: 80vh;
        }

        .column {
            flex: 1;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .card-task {
            margin-bottom: 0.75rem;
            cursor: grab;
        }

        .alert-area {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1055;
        }
    </style>
</head>
<body>

    <div class="container my-4">
        <h1 class="text-center mb-4">Kanban Mini-Trello</h1>

        <!-- Alert area -->
        <div id="alert-area" class="alert-area"></div>

        <!-- Board layout -->
        <div class="board">

            <!-- Column: Por Hacer -->
            <div class="column" data-testid="col-por-hacer" id="col-por-hacer" ondragover="event.preventDefault()" ondrop="handleDrop(event, 'Por Hacer')">
                <h4>Por Hacer</h4>
                <div class="task-list" id="list-por-hacer"></div>
            </div>

            <!-- Column: En Progreso -->
            <div class="column" data-testid="col-en-progreso" id="col-en-progreso" ondragover="event.preventDefault()" ondrop="handleDrop(event, 'En Progreso')">
                <h4>En Progreso</h4>
                <div class="task-list" id="list-en-progreso"></div>
            </div>

            <!-- Column: Hecho -->
            <div class="column" data-testid="col-hecho" id="col-hecho" ondragover="event.preventDefault()" ondrop="handleDrop(event, 'Hecho')">
                <h4>Hecho</h4>
                <div class="task-list" id="list-hecho"></div>
            </div>

        </div>

        <!-- Botón para añadir tarea -->
        <div class="text-center mt-3">
            <button id="add-task-btn" class="btn btn-primary" data-testid="add-task-button">Añadir Tarea</button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript funcionalidad Kanban -->
    <script>

        const API_URL = '/api/tasks';

        // Estado global de tareas cargadas
        let tasks = [];

        // Cargar tareas al iniciar
        async function loadTasks() {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error('Error al cargar tareas');
                tasks = await res.json();
                renderAllTasks();
            } catch (e) {
                showAlert(e.message, 'danger');
            }
        }

        // Renderizar todas las tareas en sus columnas correspondientes
        function renderAllTasks() {
            ['Por Hacer', 'En Progreso', 'Hecho'].forEach(state => {
                const list = document.getElementById(`list-${state.replace(/ /g, '-').toLowerCase()}`);
                list.innerHTML = '';
                tasks.filter(t => t.state === state).forEach(task => {
                    list.appendChild(createTaskCard(task));
                });
            });
        }

        // Crear tarjeta de tarea
        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'card card-task';
            card.setAttribute('draggable', true);
            card.dataset.id = task.id;
            card.setAttribute('data-testid', `task-${task.id}`);

            const body = document.createElement('div');
            body.className = 'card-body';

            const content = document.createElement('p');
            content.textContent = task.content;
            content.style.marginBottom = '0.5rem';

            // Editar al hacer click
            content.addEventListener('click', () => editTask(task.id, content));

            body.appendChild(content);

            const btnDelete = document.createElement('button');
            btnDelete.className = 'btn btn-danger btn-sm';
            btnDelete.textContent = 'Eliminar';
            btnDelete.addEventListener('click', () => deleteTask(task.id));

            body.appendChild(btnDelete);

            card.appendChild(body);

            // Drag events
            card.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', task.id);
                e.dataTransfer.effectAllowed = 'move';
            });

            return card;
        }

        // Editar contenido de tarea
        async function editTask(id, element) {
            const newContent = prompt('Editar contenido:', element.textContent);
            if (newContent === null || newContent.trim() === '') return;

            try {
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: newContent})
                });
                if (!res.ok) throw new Error('Error al actualizar tarea');

                const updated = await res.json();
                // Actualizar estado local y UI
                const idx = tasks.findIndex(t => t.id == id);
                tasks[idx] = updated;
                element.textContent = newContent;
                showAlert('Tarea actualizada', 'success');
            } catch (e) {
                showAlert(e.message, 'danger');
            }
        }

        // Eliminar tarea
        async function deleteTask(id) {
            if (!confirm('¿Eliminar esta tarea?')) return;

            try {
                const res = await fetch(`${API_URL}/${id}`, {method: 'DELETE'});
                if (!res.ok) throw new Error('Error al eliminar tarea');

                tasks = tasks.filter(t => t.id != id);
                document.querySelector(`[data-testid="task-${id}"]`).remove();
                showAlert('Tarea eliminada', 'success');
            } catch (e) {
                showAlert(e.message, 'danger');
            }
        }

        // Manejar drop en columnas
        async function handleDrop(event, newState) {
            const id = event.dataTransfer.getData('text/plain');
            try {
                const res = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({state: newState})
                });
                if (!res.ok) throw new Error('Error al mover tarea');

                const updated = await res.json();
                const idx = tasks.findIndex(t => t.id == id);
                tasks[idx] = updated;
                renderAllTasks();
                showAlert('Tarea movida a "' + newState + '"', 'success');
            } catch (e) {
                showAlert(e.message, 'danger');
            }
        }

        // Añadir nueva tarea
        async function addTask() {
            const content = prompt('Nuevo contenido de la tarea:');
            if (!content) return;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });
                if (!res.ok) throw new Error('Error al crear tarea');

                const newTask = await res.json();
                tasks.push(newTask);
                renderAllTasks();
                showAlert('Tarea creada', 'success');
            } catch (e) {
                showAlert(e.message, 'danger');
            }
        }

        // Mostrar alertas Bootstrap
        function showAlert(message, type = 'info') {
            const alertArea = document.getElementById('alert-area');
            const div = document.createElement('div');
            div.className = `alert alert-${type} alert-dismissible fade show`; 
            div.role = 'alert';
            div.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            alertArea.appendChild(div);
            setTimeout(() => div.remove(), 5000);
        }

        // Eventos del DOM
        document.getElementById('add-task-btn').addEventListener('click', addTask);

        // Inicializar
        loadTasks();
    </script>
</body>
</html>