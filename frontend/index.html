<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Mini-Trello</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        .board {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding-top: 2rem;
        }

        .column {
            background-color: #e9ecef;
            border-radius: 0.5rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 4rem);
        }

        .column-header {
            padding: 0.75rem 1rem;
            background-color: #ced4da;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            text-align: center;
        }

        .task-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .task-card {
            background-color: #fff;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .task-card.dragging {
            opacity: 0.6;
        }

        #new-task-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #fff;
            border-radius: 0.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

    </style>
</head>
<body>

    <div class="container-fluid">
        <h1 class="mt-4 mb-4 text-center">Kanban Mini-Trello</h1>

        <!-- Formulario de nueva tarea -->
        <form id="new-task-form" class="row g-2 align-items-center">
            <div class="col-auto">
                <input type="text" id="input-new-task" class="form-control" placeholder="Nueva tarea" required>
            </div>
            <div class="col-auto">
                <button type="submit" id="btn-add-task" class="btn btn-primary">Añadir</button>
            </div>
        </form>

        <!-- Tablero Kanban -->
        <div class="board">
            <div class="column" data-state="Por Hacer" id="col-pending">
                <div class="column-header">Por Hacer</div>
                <div class="task-list" id="list-pending"></div>
            </div>

            <div class="column" data-state="En Progreso" id="col-progress">
                <div class="column-header">En Progreso</div>
                <div class="task-list" id="list-progress"></div>
            </div>

            <div class="column" data-state="Hecho" id="col-done">
                <div class="column-header">Hecho</div>
                <div class="task-list" id="list-done"></div>
            </div>
        </div>

    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const apiUrl = '/api/tasks';

        // Mapeo de columnas por estado
        const stateToColumnId = {
            'Por Hacer': 'list-pending',
            'En Progreso': 'list-progress',
            'Hecho': 'list-done'
        };

        // Obtener y renderizar tareas al cargar
        async function loadTasks() {
            try {
                const res = await fetch(apiUrl);
                const tasks = await res.json();
                tasks.forEach(renderTask);
            } catch (e) { console.error(e); }
        }

        // Renderizar una tarjeta
        function renderTask(task) {
            const listId = stateToColumnId[task.state] || 'list-pending';
            const listEl = document.getElementById(listId);

            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.id = task.id;
            card.setAttribute('data-testid', `task-card-${task.id}`);

            // Contenido editable
            const textEl = document.createElement('p');
            textEl.textContent = task.content;
            textEl.style.marginBottom = '0';

            card.appendChild(textEl);

            // Botón eliminar
            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-danger btn-sm float-end';
            delBtn.textContent = '×';
            delBtn.setAttribute('aria-label', 'Eliminar tarea');

            card.appendChild(delBtn);

            // Eventos
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            textEl.addEventListener('dblclick', () => enableEdit(textEl, task.id));

            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteTask(task.id, card);
            });

            listEl.appendChild(card);
        }

        // Crear tarea
        document.getElementById('new-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('input-new-task');
            const content = input.value.trim();
            if (!content) return;

            try {
                const res = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (res.ok) {
                    const newTask = await res.json();
                    renderTask(newTask);
                    input.value = '';
                } else { console.error('Error al crear tarea'); }
            } catch (e) { console.error(e); }
        });

        // Editar contenido
        async function enableEdit(textEl, id) {
            const current = textEl.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = current;
            input.className = 'form-control';

            textEl.replaceWith(input);
            input.focus();

            input.addEventListener('blur', async () => {
                const newVal = input.value.trim() || current;
                try {
                    await fetch(`${apiUrl}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newVal })
                    });
                    input.replaceWith(textEl);
                    textEl.textContent = newVal;
                } catch (e) { console.error(e); }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
            });
        }

        // Eliminar tarea
        async function deleteTask(id, cardEl) {
            try {
                const res = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
                if (res.ok) { cardEl.remove(); } else { console.error('Error al eliminar'); }
            } catch (e) { console.error(e); }
        }

        // Drag & Drop
        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedCard = null;
        }

        const columns = document.querySelectorAll('.column');
        columns.forEach(col => {
            col.addEventListener('dragover', (e) => e.preventDefault());
            col.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (!draggedCard) return;

                const targetState = col.dataset.state;
                const taskId = draggedCard.dataset.id;

                try {
                    await fetch(`${apiUrl}/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ state: targetState })
                    });

                    col.querySelector('.task-list').appendChild(draggedCard);
                } catch (e) { console.error(e); }
            });
        });

        // Inicializar
        loadTasks();
    </script>
</body>
</html>