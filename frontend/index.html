<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini-Trello Kanban</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      .kanban-board {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 1rem;
          padding: 1rem;
      }

      .kanban-column {
          background-color: #f8f9fa;
          border-radius: 0.5rem;
          min-height: 400px;
          display: flex;
          flex-direction: column;
      }

      .kanban-header {
          padding: 0.75rem;
          font-weight: bold;
          background-color: #e9ecef;
          border-bottom: 1px solid #dee2e6;
      }

      .task-card {
          margin: 0.5rem;
          padding: 0.75rem;
          background-color: #fff;
          border-radius: 0.25rem;
          box-shadow: 0 1px 3px rgba(0,0,0,.2);
          cursor: grab;
      }

      .task-card:active {
          cursor: grabbing;
      }

      .add-task-form {
          padding: 0.75rem;
      }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="my-4 text-center">Mini-Trello Kanban</h1>

        <div class="kanban-board" id="board" data-testid="kanban-board">

            <!-- Column: Por Hacer -->
            <div class="kanban-column" data-state="Por Hacer" data-testid="column-por-hacer">
                <div class="kanban-header" data-testid="header-por-hacer">Por Hacer</div>

                <!-- Form to add new task -->
                <form class="add-task-form" onsubmit="return addTask(event);" data-testid="form-add-task">
                    <div class="mb-3">
                        <label for="new-task-input" class="form-label">Nueva tarea</label>
                        <input type="text" id="new-task-input" class="form-control" placeholder="Escribe la tarea..." required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" data-testid="add-task-button">AÃ±adir</button>
                </form>

                <!-- Tasks container -->
                <div class="tasks-container" id="por-hacer-tasks"></div>
            </div>

            <!-- Column: En Progreso -->
            <div class="kanban-column" data-state="En Progreso" data-testid="column-en-progreso">
                <div class="kanban-header" data-testid="header-en-progreso">En Progreso</div>
                <div class="tasks-container" id="en-progreso-tasks"></div>
            </div>

            <!-- Column: Hecho -->
            <div class="kanban-column" data-state="Hecho" data-testid="column-hecho">
                <div class="kanban-header" data-testid="header-hecho">Hecho</div>
                <div class="tasks-container" id="hecho-tasks"></div>
            </div>

        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const apiBase = '/api/tasks';

      // Fetch and render all tasks on load
      document.addEventListener('DOMContentLoaded', () => {
          fetchTasks();
      });

      function fetchTasks() {
          fetch(apiBase)
              .then(res => res.json())
              .then(tasks => {
                  tasks.forEach(task => addTaskCard(task));
              })
              .catch(err => console.error('Error fetching tasks:', err));
      }

      function addTask(event) {
          event.preventDefault();
          const input = document.getElementById('new-task-input');
          const content = input.value.trim();
          if (!content) return;

          fetch(apiBase, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({content})
          })
              .then(res => res.json())
              .then(task => {
                  addTaskCard(task);
                  input.value = '';
              })
              .catch(err => console.error('Error adding task:', err));

          return false;
      }

      function addTaskCard(task) {
          const containerId = `${task.state.toLowerCase().replace(/ /g, '-')}-tasks`;
          const container = document.getElementById(containerId);

          const card = document.createElement('div');
          card.className = 'task-card';
          card.draggable = true;
          card.dataset.id = task.id;
          card.dataset.state = task.state;
          card.textContent = task.content;
          card.setAttribute('data-testid', `task-${task.id}`);

          // Click to edit content
          card.addEventListener('click', () => {
              const newText = prompt('Editar tarea:', task.content);
              if (newText !== null && newText.trim() !== '') {
                  updateTask(task.id, {content: newText.trim()});
              }
          });

          // Drag events
          card.addEventListener('dragstart', e => {
              e.dataTransfer.setData('text/plain', task.id);
          });

          container.appendChild(card);
      }

      function updateTask(id, updates) {
          fetch(`${apiBase}/${id}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(updates)
          })
              .then(res => res.json())
              .then(updatedTask => {
                  // Move card if state changed
                  const oldCard = document.querySelector(`.task-card[data-id="${id}"]`);
                  if (oldCard && updatedTask.state !== oldCard.dataset.state) {
                      oldCard.remove();
                      addTaskCard(updatedTask);
                  } else if (oldCard) {
                      oldCard.textContent = updatedTask.content;
                      oldCard.dataset.state = updatedTask.state;
                  }
              })
              .catch(err => console.error('Error updating task:', err));
      }

      // Drag over and drop handlers for columns
      const columns = document.querySelectorAll('.kanban-column');
      columns.forEach(col => {
          col.addEventListener('dragover', e => e.preventDefault());
          col.addEventListener('drop', e => {
              e.preventDefault();
              const taskId = e.dataTransfer.getData('text/plain');
              const newState = col.dataset.state;
              updateTask(taskId, {state: newState});
          });
      });

    </script>
</body>
</html>