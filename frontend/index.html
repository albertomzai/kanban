<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kanban Board</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    
    <div class="container mt-5">
        <h1>Kanban Board</h1>
        
        <div class="d-flex justify-content-between mb-3">
            <div class="col-md-4" data-testid="column-to-do">
                <h2>Por Hacer</h2>
                <div id="to-do-column" class="list-group"></div>
            </div>
            <div class="col-md-4" data-testid="column-in-progress">
                <h2>En Progreso</h2>
                <div id="in-progress-column" class="list-group"></div>
            </div>
            <div class="col-md-4" data-testid="column-done">
                <h2>Hecho</h2>
                <div id="done-column" class="list-group"></div>
            </div>
        </div>
        
        <form id="new-task-form" class="mb-3">
            <div class="input-group">
                <input type="text" class="form-control" id="task-input" placeholder="Nueva tarea..." required>
                <button type="submit" class="btn btn-primary">Añadir</button>
            </div>
        </form>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const toDoColumn = document.getElementById('to-do-column');
            const inProgressColumn = document.getElementById('in-progress-column');
            const doneColumn = document.getElementById('done-column');
            const newTaskForm = document.getElementById('new-task-form');

            async function fetchTasks() {
                try {
                    const response = await fetch('/api/tasks');
                    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                    alert('Error al obtener las tareas. Por favor, inténtelo de nuevo.');
                }
            }

            async function createTask(content) {
                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content, status: 'Por Hacer' })
                    });
                    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                    return await response.json();
                } catch (error) {
                    console.error('Error creating task:', error);
                    alert('Error al crear la tarea. Por favor, inténtelo de nuevo.');
                }
            }

            async function updateTask(id, status) {
                try {
                    const response = await fetch(`/api/tasks/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                } catch (error) {
                    console.error('Error updating task:', error);
                    alert('Error al actualizar la tarea. Por favor, inténtelo de nuevo.');
                }
            }

            async function deleteTask(id) {
                try {
                    const response = await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Error al eliminar la tarea. Por favor, inténtelo de nuevo.');
                }
            }

            function renderTasks(tasks) {
                toDoColumn.innerHTML = '';
                inProgressColumn.innerHTML = '';
                doneColumn.innerHTML = '';

                tasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = 'list-group-item d-flex justify-content-between align-items-center';
                    card.draggable = true;
                    card.dataset.taskId = task.id;
                    card.dataset.status = task.status;
                    card.innerHTML = `<span>${task.content}</span> <button class='btn btn-danger btn-sm'>Eliminar</button>`;

                    const deleteButton = card.querySelector('button');
                    deleteButton.addEventListener('click', () => {
                        deleteTask(task.id);
                        renderTasks(tasks.filter(t => t.id !== task.id));
                    });

                    if (task.status === 'Por Hacer') toDoColumn.appendChild(card);
                    else if (task.status === 'En Progreso') inProgressColumn.appendChild(card);
                    else doneColumn.appendChild(card);
                });

                document.querySelectorAll('.list-group-item').forEach(item => {
                    item.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', item.dataset.taskId);
                    });
                });

                document.querySelectorAll('.list-group').forEach(column => {
                    column.addEventListener('dragover', e => e.preventDefault());
                    column.addEventListener('drop', async e => {
                        const taskId = e.dataTransfer.getData('text/plain');
                        const newStatus = column.dataset.status;
                        await updateTask(taskId, newStatus);
                        renderTasks(await fetchTasks());
                    });
                });
            }

            newTaskForm.addEventListener('submit', async e => {
                e.preventDefault();
                const content = document.getElementById('task-input').value.trim();
                if (content) {
                    await createTask(content);
                    document.getElementById('task-input').value = '';
                    renderTasks(await fetchTasks());
                }
            });

            renderTasks(await fetchTasks());
        });
    </script>
</body>
</html>